<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #ccc;
        }
        .test-item.pending {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .test-item.success {
            background: #d4edda;
            border-color: #28a745;
        }
        .test-item.error {
            background: #f8d7da;
            border-color: #dc3545;
        }
        .test-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .test-result {
            font-size: 14px;
            color: #666;
        }
        button {
            background: #4a90d9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        button:hover {
            background: #357abd;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>ğŸ” Supabase è¿æ¥è¯Šæ–­</h1>
        
        <div id="test-config" class="test-item pending">
            <div class="test-name">1. æ£€æŸ¥é…ç½®</div>
            <div class="test-result">ç­‰å¾…æµ‹è¯•...</div>
        </div>
        
        <div id="test-connection" class="test-item pending">
            <div class="test-name">2. æµ‹è¯•ç½‘ç»œè¿æ¥</div>
            <div class="test-result">ç­‰å¾…æµ‹è¯•...</div>
        </div>
        
        <div id="test-auth" class="test-item pending">
            <div class="test-name">3. æµ‹è¯•è®¤è¯æœåŠ¡</div>
            <div class="test-result">ç­‰å¾…æµ‹è¯•...</div>
        </div>
        
        <div id="test-database" class="test-item pending">
            <div class="test-name">4. æµ‹è¯•æ•°æ®åº“è¿æ¥</div>
            <div class="test-result">ç­‰å¾…æµ‹è¯•...</div>
        </div>
        
        <button onclick="runTests()">å¼€å§‹æµ‹è¯•</button>
        
        <div id="detailed-log" style="margin-top: 20px;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config/supabase-config.js"></script>
    
    <script>
        let supabase;
        
        function updateTest(id, status, message) {
            const element = document.getElementById(id);
            element.className = `test-item ${status}`;
            element.querySelector('.test-result').textContent = message;
        }
        
        function addLog(message, data = null) {
            const logDiv = document.getElementById('detailed-log');
            const logItem = document.createElement('div');
            logItem.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            if (data) {
                logItem.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            logDiv.appendChild(logItem);
        }
        
        async function runTests() {
            addLog('å¼€å§‹è¯Šæ–­æµ‹è¯•...');
            
            // æµ‹è¯• 1: æ£€æŸ¥é…ç½®
            try {
                addLog('æ£€æŸ¥é…ç½®æ–‡ä»¶...');
                if (!SUPABASE_CONFIG || !SUPABASE_CONFIG.url || !SUPABASE_CONFIG.anonKey) {
                    throw new Error('é…ç½®æ–‡ä»¶ä¸å®Œæ•´');
                }
                
                updateTest('test-config', 'success', `âœ“ é…ç½®æ­£ç¡®\nURL: ${SUPABASE_CONFIG.url}`);
                addLog('é…ç½®æ£€æŸ¥é€šè¿‡', SUPABASE_CONFIG);
                
                // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
                supabase = window.supabase.createClient(
                    SUPABASE_CONFIG.url,
                    SUPABASE_CONFIG.anonKey
                );
                addLog('Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–');
                
            } catch (error) {
                updateTest('test-config', 'error', `âœ— é…ç½®é”™è¯¯: ${error.message}`);
                addLog('é…ç½®æ£€æŸ¥å¤±è´¥', error);
                return;
            }
            
            // æµ‹è¯• 2: æµ‹è¯•ç½‘ç»œè¿æ¥
            try {
                addLog('æµ‹è¯•ç½‘ç»œè¿æ¥...');
                const response = await fetch(SUPABASE_CONFIG.url + '/rest/v1/', {
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey
                    }
                });
                
                if (response.ok) {
                    updateTest('test-connection', 'success', 'âœ“ ç½‘ç»œè¿æ¥æ­£å¸¸');
                    addLog('ç½‘ç»œè¿æ¥æµ‹è¯•é€šè¿‡', { status: response.status });
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateTest('test-connection', 'error', `âœ— ç½‘ç»œè¿æ¥å¤±è´¥: ${error.message}`);
                addLog('ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥', error);
                return;
            }
            
            // æµ‹è¯• 3: æµ‹è¯•è®¤è¯æœåŠ¡
            try {
                addLog('æµ‹è¯•è®¤è¯æœåŠ¡...');
                
                // å°è¯•è·å–ä¼šè¯ï¼ˆä¸ä¼šæŠ¥é”™ï¼Œåªæ˜¯æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨ï¼‰
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    throw error;
                }
                
                updateTest('test-auth', 'success', 'âœ“ è®¤è¯æœåŠ¡æ­£å¸¸');
                addLog('è®¤è¯æœåŠ¡æµ‹è¯•é€šè¿‡', data);
                
            } catch (error) {
                updateTest('test-auth', 'error', `âœ— è®¤è¯æœåŠ¡å¤±è´¥: ${error.message}`);
                addLog('è®¤è¯æœåŠ¡æµ‹è¯•å¤±è´¥', error);
                
                // æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                if (error.message.includes('Failed to fetch')) {
                    addLog('âš ï¸ å¯èƒ½çš„åŸå› ï¼š', {
                        '1': 'Supabase é¡¹ç›®æœªå¯åŠ¨æˆ–å·²æš‚åœ',
                        '2': 'ç½‘ç»œé˜²ç«å¢™é˜»æ­¢äº†è¯·æ±‚',
                        '3': 'CORS é…ç½®é—®é¢˜',
                        '4': 'API URL æˆ– Key ä¸æ­£ç¡®'
                    });
                }
                return;
            }
            
            // æµ‹è¯• 4: æµ‹è¯•æ•°æ®åº“è¿æ¥
            try {
                addLog('æµ‹è¯•æ•°æ®åº“è¿æ¥...');
                
                const { data, error } = await supabase
                    .from('credentials')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œè¿™æ˜¯é¢„æœŸçš„é”™è¯¯
                    if (error.message.includes('relation') || error.message.includes('does not exist')) {
                        updateTest('test-database', 'error', 'âœ— æ•°æ®è¡¨æœªåˆ›å»º\nè¯·åœ¨ Supabase æ§åˆ¶å°è¿è¡Œ SQL åˆ›å»ºè¡¨');
                        addLog('âš ï¸ æ•°æ®è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦è¿è¡Œ SQL åˆ›å»ºè¡¨');
                    } else {
                        throw error;
                    }
                } else {
                    updateTest('test-database', 'success', 'âœ“ æ•°æ®åº“è¿æ¥æ­£å¸¸');
                    addLog('æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡');
                }
                
            } catch (error) {
                updateTest('test-database', 'error', `âœ— æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`);
                addLog('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥', error);
            }
            
            addLog('âœ… è¯Šæ–­æµ‹è¯•å®Œæˆï¼');
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        window.addEventListener('load', () => {
            addLog('é¡µé¢åŠ è½½å®Œæˆ');
            addLog('å½“å‰é…ç½®', {
                url: SUPABASE_CONFIG.url,
                anonKey: SUPABASE_CONFIG.anonKey.substring(0, 50) + '...'
            });
        });
    </script>
</body>
</html>
